<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Portswigger Web Academic 真的顶！">
<meta property="og:type" content="article">
<meta property="og:title" content="Portswigger 不安全的反序列化">
<meta property="og:url" content="https://zhangyijian.cn/Notes/Insecure%20Deserialization/index.html">
<meta property="og:site_name" content="人生边上">
<meta property="og:description" content="Portswigger Web Academic 真的顶！">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/91Quin/-for-hexo/main/img/202403051622176.png">
<meta property="og:image" content="https://raw.githubusercontent.com/91Quin/-for-hexo/main/img/202403051621238.png">
<meta property="og:image" content="https://raw.githubusercontent.com/91Quin/-for-hexo/main/img/202403051621867.png">
<meta property="article:published_time" content="2024-02-26T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-09T15:22:33.710Z">
<meta property="article:author" content="Yijian">
<meta property="article:tag" content="知识&#x2F;cybersecurity">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="知识&#x2F;笔记">
<meta property="article:tag" content="草稿">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/91Quin/-for-hexo/main/img/202403051622176.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Portswigger 不安全的反序列化</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/91Quin">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/Notes/%E5%80%9F%E5%8A%A9race%20condition%E7%9A%84Web%20shell%E4%B8%8A%E4%BC%A0/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/Notes/%E6%96%87%E7%8C%AE%E9%98%85%E8%AF%BB/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zhangyijian.cn/Notes/Insecure%20Deserialization/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&text=Portswigger 不安全的反序列化"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&is_video=false&description=Portswigger 不安全的反序列化"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Portswigger 不安全的反序列化&body=Check out this article: https://zhangyijian.cn/Notes/Insecure%20Deserialization/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&name=Portswigger 不安全的反序列化&description=&lt;p&gt;Portswigger Web Academic 真的顶！&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&t=Portswigger 不安全的反序列化"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Insecure-deserialization"><span class="toc-number">1.</span> <span class="toc-text">Insecure deserialization</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-serialization"><span class="toc-number">1.1.</span> <span class="toc-text">What is serialization?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Serialization-vs-deserialization"><span class="toc-number">1.1.1.</span> <span class="toc-text">Serialization vs deserialization</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-insecure-deserialization"><span class="toc-number">1.2.</span> <span class="toc-text">What is insecure deserialization?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-do-insecure-deserialization-vulnerabilities-arise"><span class="toc-number">1.3.</span> <span class="toc-text">How do insecure deserialization vulnerabilities arise?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-the-impact-of-insecure-deserialization"><span class="toc-number">1.4.</span> <span class="toc-text">What is the impact of insecure deserialization?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-insecure-deserialization-vulnerabilities"><span class="toc-number">2.</span> <span class="toc-text">Exploiting insecure deserialization vulnerabilities</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-identify-insecure-deserialization"><span class="toc-number">2.1.</span> <span class="toc-text">How to identify insecure deserialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-serialization-format"><span class="toc-number">2.1.1.</span> <span class="toc-text">PHP serialization format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-serialization-format"><span class="toc-number">2.1.2.</span> <span class="toc-text">Java serialization format</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Manipulating-serialized-objects"><span class="toc-number">2.2.</span> <span class="toc-text">Manipulating serialized objects</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Modifying-object-attributes"><span class="toc-number">2.2.1.</span> <span class="toc-text">Modifying object attributes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB-Modifying-serialized-objects"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">LAB: Modifying serialized objects</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Modifying-data-types"><span class="toc-number">2.2.2.</span> <span class="toc-text">Modifying data types</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB-Modifying-serialized-data-types"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">LAB : Modifying serialized data types</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-application-functionality"><span class="toc-number">2.3.</span> <span class="toc-text">Using application functionality</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB-Using-application-functionality-to-exploit-insecure-deserialization"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">LAB: Using application functionality to exploit insecure deserialization</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Magic-methods"><span class="toc-number">2.4.</span> <span class="toc-text">Magic methods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Injecting-arbitrary-objects"><span class="toc-number">2.5.</span> <span class="toc-text">Injecting arbitrary objects</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Lab-Arbitrary-object-injection-in-PHP"><span class="toc-number">2.5.0.1.</span> <span class="toc-text">Lab: Arbitrary object injection in PHP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gadget-chains"><span class="toc-number">2.6.</span> <span class="toc-text">Gadget chains</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Working-with-pre-built-gadget-chains"><span class="toc-number">2.6.1.</span> <span class="toc-text">Working with pre-built gadget chains</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ysoserial"><span class="toc-number">2.6.1.1.</span> <span class="toc-text">ysoserial</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Note"><span class="toc-number">2.6.1.2.</span> <span class="toc-text">Note</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lab-Exploiting-Java-deserialization-with-Apache-Commons"><span class="toc-number">2.6.1.3.</span> <span class="toc-text">Lab: Exploiting Java deserialization with Apache Commons</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PHP-Generic-Gadget-Chains"><span class="toc-number">2.6.1.4.</span> <span class="toc-text">PHP Generic Gadget Chains</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lab-Exploiting-PHP-deserialization-with-a-pre-built-gadget-chain"><span class="toc-number">2.6.1.5.</span> <span class="toc-text">Lab: Exploiting PHP deserialization with a pre-built gadget chain</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-prevent-insecure-deserialization-vulnerabilities"><span class="toc-number">2.7.</span> <span class="toc-text">How to prevent insecure deserialization vulnerabilities</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Portswigger 不安全的反序列化
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Yijian</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-02-26T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-02-27</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Web/" rel="tag">Web</a>, <a class="p-category" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a>, <a class="p-category" href="/tags/%E7%9F%A5%E8%AF%86-cybersecurity/" rel="tag">知识/cybersecurity</a>, <a class="p-category" href="/tags/%E7%9F%A5%E8%AF%86-%E7%AC%94%E8%AE%B0/" rel="tag">知识/笔记</a>, <a class="p-category" href="/tags/%E8%8D%89%E7%A8%BF/" rel="tag">草稿</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>Portswigger Web Academic 真的顶！</p>
<span id="more"></span>
<h1 id="Insecure-deserialization"><a href="#Insecure-deserialization" class="headerlink" title="Insecure deserialization"></a>Insecure deserialization</h1><h2 id="What-is-serialization"><a href="#What-is-serialization" class="headerlink" title="What is serialization?"></a>What is serialization?</h2><blockquote>
<p><strong>Serialization</strong> is the process of converting complex data structures, such as objects and their fields, into a “flatter” format that can be sent and received as a sequential stream of bytes.</p>
</blockquote>
<p>序列化：把对象转换成bytes流，以便向进程内存、文件或是数据库中写入复杂数据( complex data ，我理解的既是图中的object)</p>
<h3 id="Serialization-vs-deserialization"><a href="#Serialization-vs-deserialization" class="headerlink" title="Serialization vs deserialization"></a>Serialization vs deserialization</h3><p>反序列化Serialization即是把Stream of Bytes再转换成序列化之前的object<br><img src="https://raw.githubusercontent.com/91Quin/-for-hexo/main/img/202403051622176.png">不同语言的序列化方式不同，最后可能转换成二进制或者字符串。对象的属性（包括私有属性）也会被转化到Stream of Bytes。如果这个字段不想被序列化，需要标记为”transient”</p>
<h2 id="What-is-insecure-deserialization"><a href="#What-is-insecure-deserialization" class="headerlink" title="What is insecure deserialization?"></a>What is insecure deserialization?</h2><p>网站反序列化数据时，如果这个数据可以被用户控制，attacker就可能利用被序列化的对象，向程序代码中插入有害信息。</p>
<blockquote>
<p>介不还是注入吗？</p>
</blockquote>
<p>甚至可能用另一类对象替代一个被序列化的对象。</p>
<blockquote>
<p>insecure deserialization is sometimes known as an “object injection” vulnerability.确实是注入</p>
</blockquote>
<p>对象的类和预期不符就可能造成意料之外的结果，然后就造成损害了。许多利用反序列化漏洞的攻击，在完成反序列化过程之前，就完成了。因此，即便是网站自身功能不与恶意对象交互，反序列化过程本身就会完成attack。这样的话，即便网站logic使用strongly typed languages，也会受影响。</p>
<h2 id="How-do-insecure-deserialization-vulnerabilities-arise"><a href="#How-do-insecure-deserialization-vulnerabilities-arise" class="headerlink" title="How do insecure deserialization vulnerabilities arise?"></a>How do insecure deserialization vulnerabilities arise?</h2><p>反序列化漏洞出现，一般就是因为对用户可控数据能造成的危害缺乏认识。</p>
<p>有时网站使用额外的安全检查，也不一定有效。因为不可能每种情况都考虑到，而且往往是在反序列化过程后检查，这就晚了。</p>
<h2 id="What-is-the-impact-of-insecure-deserialization"><a href="#What-is-the-impact-of-insecure-deserialization" class="headerlink" title="What is the impact of insecure deserialization?"></a>What is the impact of insecure deserialization?</h2><p>一般都很严重，因为可以极大地扩大攻击面，允许攻击者重用程序代码，最后可能就rce了。就算不能rce，也会导致越权，任意文件访问和dos攻击。</p>
<h1 id="Exploiting-insecure-deserialization-vulnerabilities"><a href="#Exploiting-insecure-deserialization-vulnerabilities" class="headerlink" title="Exploiting insecure deserialization vulnerabilities"></a>Exploiting insecure deserialization vulnerabilities</h1><blockquote>
<p>We hope to demonstrate how exploiting insecure deserialization is actually much easier than many people believe. This is even the case during blackbox testing if you are able to use pre-built gadget chains.似乎看到了熟悉的东西，这个gadget chains会是什么呢？</p>
</blockquote>
<h2 id="How-to-identify-insecure-deserialization"><a href="#How-to-identify-insecure-deserialization" class="headerlink" title="How to identify insecure deserialization"></a>How to identify insecure deserialization</h2><h3 id="PHP-serialization-format"><a href="#PHP-serialization-format" class="headerlink" title="PHP serialization format"></a>PHP serialization format</h3><p>php就用mostly human-readable string format，字母代表数据类型，数字代表每一项的长度。</p>
<figure class="highlight plaintext"><figcaption><span>```object with the attributes:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">```php</span><br><span class="line">$user-&gt;name = &quot;carlos&quot;; </span><br><span class="line">$user-&gt;isLoggedIn = true;</span><br></pre></td></tr></table></figure>
<p>序列化之后：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">&quot;User&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>:s:<span class="number">6</span>:<span class="string">&quot;carlos&quot;</span>; s:<span class="number">10</span>:<span class="string">&quot;isLoggedIn&quot;</span>:b:<span class="number">1</span>;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/91Quin/-for-hexo/main/img/202403051621238.png"><br>相应php函数：<code>serialize()</code> <code>unserialize()</code></p>
<h3 id="Java-serialization-format"><a href="#Java-serialization-format" class="headerlink" title="Java serialization format"></a>Java serialization format</h3><p>Java使用二进制序列化格式。但是如果知道怎么去辨别一些迹象，还是能分辨出serialized data的。</p>
<blockquote>
<p>For example, serialized Java objects always begin with the same bytes, which are encoded as <code>ac ed</code> in hexadecimal and <code>rO0</code> in Base64.</p>
</blockquote>
<p>对Java来说，则需要关注<code>readObject()</code>，这个函数被用来读和反序列化输入流的数据</p>
<h2 id="Manipulating-serialized-objects"><a href="#Manipulating-serialized-objects" class="headerlink" title="Manipulating serialized objects"></a>Manipulating serialized objects</h2><blockquote>
<p>Exploiting some deserialization vulnerabilities can be as easy as changing an attribute in a serialized object.</p>
</blockquote>
<p>emmm,第一步：改变属性值。有两种方法可以去利用序列化了的对象：其一，直接编辑 byte stream ；其二，用相应的语言写个脚本，自己创建并序列化一个新对象，这种方法在处理二进制序列化格式时更方便。</p>
<h3 id="Modifying-object-attributes"><a href="#Modifying-object-attributes" class="headerlink" title="Modifying object attributes"></a>Modifying object attributes</h3><blockquote>
<p>When tampering with the data, as long as the attacker preserves a valid serialized object, the deserialization process will create a server-side object with the modified attribute values.<br><img src="https://raw.githubusercontent.com/91Quin/-for-hexo/main/img/202403051621867.png"><br>?? 这么简单的吗？</p>
</blockquote>
<p>并不是，还需要一个条件：”website uses this cookie to check whether the current user has access to certain administrative functionality.”emmm，真的会有人这样做吗？</p>
<blockquote>
<p>“This simple scenario is not common in the wild.”看来大家都有共识XD</p>
</blockquote>
<h4 id="LAB-Modifying-serialized-objects"><a href="#LAB-Modifying-serialized-objects" class="headerlink" title="LAB: Modifying serialized objects"></a>LAB: Modifying serialized objects</h4><blockquote>
<p>扬帆起航！</p>
</blockquote>
<ol>
<li>刚开始看了几个包，没头绪，看不到任何byte stream。</li>
<li>看了返回的包后，想起cookie了，发现很像base64，传去decoder，一切就顺理成章起来</li>
<li>emmm ，改错了，弱智了，得在request里改，整成在response里改了</li>
<li>成功出现admin panel</li>
<li>但是并没有完，修改了request包中的字段，浏览器发的cookie还是原来的，还得改浏览器中的cookie</li>
<li>F12 在application栏中修改cookie即可</li>
</ol>
<h3 id="Modifying-data-types"><a href="#Modifying-data-types" class="headerlink" title="Modifying data types"></a>Modifying data types</h3><p>不仅可以修改object的属性值，也可以利用预期之外的数据类型。</p>
<p>这里提到，PHP-based logic 尤其易受影响。因为php的比较运算符<code>==</code>在比较不同数据类型时判定得很宽松。emmm，我好像在那个meme上看到过，有点印象，是JavaScript还是PHP来着？</p>
<p>以数字开头的字符串也适用于<code>5 == &quot;5&quot;</code>这一点，PHP会把整个字符串转换成开头得数字，同时忽略其他部分。<code>5 == &quot;5 of something&quot;</code></p>
<blockquote>
<p>This becomes even stranger when comparing a string the integer <code>0</code>:</p>
<p><code>0 == &quot;Example string&quot; // true // wtf?</code></p>
</blockquote>
<blockquote>
<p>“ Because there is no number, that is, 0 numerals in the string. PHP treats this entire string as the integer <code>0</code>.”</p>
<p>emmm,很难评价</p>
</blockquote>
<p>因此在面对如下代码时</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$login</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_COOKIE</span>) </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$login</span>[<span class="string">&#x27;password&#x27;</span>] == <span class="variable">$password</span>) &#123; </span><br><span class="line"><span class="comment">// log in successfully </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以使用这一性质”enabling an authentication bypass.“但也是有条件的：</p>
<blockquote>
<p>Note that this is only possible because deserialization preserves the data type. If the code fetched the password from the request directly, the <code>0</code> would be converted to a string and the condition would evaluate to <code>false</code>.</p>
</blockquote>
<p>而且要记得更新type labels 和 length indicators：</p>
<blockquote>
<p>Be aware that when modifying data types in any serialized object format, it is important to remember to update any type labels and length indicators in the serialized data too. Otherwise, the serialized object will be corrupted and will not be deserialized.</p>
</blockquote>
<p>这里它还推荐了一个扩展：Hackvertor ， 在处理二进制数据时，可以把序列化的数据格式化成字符串，并自动更新二进制数据，调整偏移量。</p>
<h4 id="LAB-Modifying-serialized-data-types"><a href="#LAB-Modifying-serialized-data-types" class="headerlink" title="LAB : Modifying serialized data types"></a>LAB : Modifying serialized data types</h4><ol>
<li>题目描述中，”is vulnerable to authentication bypass as a result. “，达到”edit the serialized object in the session cookie to access the <code>administrator</code> account. Then, delete the user <code>carlos</code>.“即可</li>
<li>有了上次的经验，查看cookie，base64解码后为<code>O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;wiener&quot;;s:12:&quot;access_token&quot;;s:32:&quot;kkbu4w4wcyqhanxqvlp42eocv9o5hxui&quot;;&#125;</code><blockquote>
<p>by the way ,这hackvertor不咋会用啊，它GitHub上写的不是很简单吗？</p>
</blockquote>
</li>
<li>把access_token 相应length改为1，值改为0。emmm，需不需要改类型呢？我也不知道php里integer缩写成啥啊？</li>
<li>报错<code>PHP Fatal error: Uncaught Exception: unserialize() failed in /var/www/index.php:4 Stack trace: #0 &#123;main&#125; thrown in /var/www/index.php on line 4</code></li>
<li><a target="_blank" rel="noopener" href="https://www.programming-books.io/essential/php/serialization-of-different-types-3b8a66c6eaab4931b5dc0386b88bdcc2">序列化不同类型</a><blockquote>
<p>原来不是hackvertor的问题，我的问题，session中值需要先<code>d_url</code> then <code>d_base64</code></p>
</blockquote>
</li>
<li>相应字段改为<code>i:0</code>，再生成新的cookie即可</li>
</ol>
<h2 id="Using-application-functionality"><a href="#Using-application-functionality" class="headerlink" title="Using application functionality"></a>Using application functionality</h2><p>除了蠢蠢地检查属性值外，website的功能可能在反序列化了的object上执行危险操作。</p>
<p>举例：“Delete user”功能，删除用户的头像文件是通过“accessing the file path in the <code>$user-&gt;image_location</code> attribute.”实现的。如果传个修改过<code>image_location</code>值的object，就可以删除任意文件了。</p>
<p>”Lab是手工做的，但如果自动地 pass data into dangerous methods 来利用漏洞，情况会很有趣“然后引出了下一节，Magic methods</p>
<h4 id="LAB-Using-application-functionality-to-exploit-insecure-deserialization"><a href="#LAB-Using-application-functionality-to-exploit-insecure-deserialization" class="headerlink" title="LAB: Using application functionality to exploit insecure deserialization"></a>LAB: Using application functionality to exploit insecure deserialization</h4><ol>
<li>‘A certain feature invokes a dangerous method on data provided in a serialized object.’，而且这里指明了’the serialized object in the session cookie’ </li>
<li>还给了个备用账户，不知道干嘛的</li>
<li>出现了个delete account，先用别的试试，有点明白这个backup account是干嘛的了<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O<span class="punctuation">:</span><span class="number">4</span><span class="punctuation">:</span><span class="attr">&quot;User&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">:</span><span class="punctuation">&#123;</span>s<span class="punctuation">:</span><span class="number">8</span><span class="punctuation">:</span><span class="string">&quot;username&quot;</span>;s<span class="punctuation">:</span><span class="number">6</span><span class="punctuation">:</span><span class="string">&quot;wiener&quot;</span>;s<span class="punctuation">:</span><span class="number">12</span><span class="punctuation">:</span><span class="string">&quot;access_token&quot;</span>;s<span class="punctuation">:</span><span class="number">32</span><span class="punctuation">:</span><span class="string">&quot;omu50cbc6k2m7c638uy9j9u15zmv9oa2&quot;</span>;s<span class="punctuation">:</span><span class="number">11</span><span class="punctuation">:</span><span class="string">&quot;avatar_link&quot;</span>;s<span class="punctuation">:</span><span class="number">19</span><span class="punctuation">:</span><span class="string">&quot;users/wiener/avatar&quot;</span>;<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>emmm，我猜avatar_link 即指明了头像的地址，改这个。但是，emmm，不大确定这个目录结构怎么回事，放在了users下面吗。emmm，对哦。这是个web application，确实，想错了吧可能我。</li>
<li>以防万一，传个头像上去看下location</li>
<li>emmm，弄巧成拙了，传的lenna图，结果太大了，自己打不开了。</li>
<li>所以我猜测目录结构是<code>/home/Carlos/morale.txt</code>,23个字符</li>
<li>失败力！明白备用账户干嘛的了</li>
<li>也许我想错目录了？</li>
<li><code>/users/Carlos/morale.txt</code>, 24个字符</li>
<li>好的，俩账户删完了，没解决，太棒了</li>
<li>完了，我也不知道这个咋重置，太棒了</li>
<li>等15分钟</li>
<li>看了眼solution，<code>/home/Carlos/morale.txt</code>这个地址猜的是正确的，但是全是小写，username写错了，悲伤，逆流成河。</li>
</ol>
<h2 id="Magic-methods"><a href="#Magic-methods" class="headerlink" title="Magic methods"></a>Magic methods</h2><p>“Instead, they are invoked automatically whenever a particular event or scenario occurs.”我不明白？上一个是在删除用户时invoke的，这个难道什么都不需要做？</p>
<p>“ They are sometimes indicated by prefixing or surrounding the method name with double-underscores.” </p>
<blockquote>
<p>Developers can add magic methods to a class in order to predetermine what code should be executed when the corresponding event or scenario occurs.</p>
</blockquote>
<p>就像创建对象时，执行构造函数那样吗？”One of the most common examples in PHP is <code>__construct()</code>, which is invoked whenever an object of the class is instantiated, similar to Python’s <code>__init__</code>.“😕，我想我接近了正确答案。</p>
<p>通常情况下Magic methods本身没有漏洞。”But they can become dangerous when the code that they execute handles attacker-controllable data“ 他举例说，攻击者如果构造的反序列化对象符合相应条件时，就可以”automatically invoke methods“</p>
<p>”some languages have magic methods that are invoked automatically <strong>during</strong> the deserialization process.“ 举例：PHP’s unserialize() method looks for and invokes an object’s __wakeup() magic method.还有Java的<code>ObjectInputStream.readObject()</code>Java的<code>Serializable</code>也是可以声明自己的<code>readObject()</code>这个<code>readObject()</code>在反序列化过程中也就会被调用。</p>
<p>我有点明白，为什么上文中举出额外的安全检查也不一定有效了。</p>
<p>” They allow you to pass data from a serialized object into the website’s code before the object is fully deserialized. This is the starting point for creating more advanced exploits.“😕(by the way , 我是真喜欢撇嘴这个表情) </p>
<h2 id="Injecting-arbitrary-objects"><a href="#Injecting-arbitrary-objects" class="headerlink" title="Injecting arbitrary objects"></a>Injecting arbitrary objects</h2><p>“ injecting arbitrary object types can open up many more possibilities.”攻击者通过控制序列化数据中object的类，来影响反序列化后，反序列化过程中 ， 所执行的代码。</p>
<p>”Deserialization methods do not typically check what they are deserializing.“所以只要是website能用的，可以传，然后被反序列化。攻击者就可以据此，创建任意类的实例。”The unexpected object type might cause an exception in the application logic, but the malicious object will already be instantiated by then.“不明白，🤔，我想可能是说实例化恶意代码，尽管传个别的类对象可能会引起website logic 意料之外的结果，但恶意代码总归是传上去了（？）。</p>
<p>”The attacker can then pass in a serialized object of this class to use its magic method for an exploit.“结合上一节，构造所选取的class还是有所取向的，当然这是”has access to the source code“的情况。</p>
<p>”Classes containing these deserialization magic methods can also be used to initiate more complex attacks involving a long series of method invocations, known as a “gadget chain”.“要来力🙌</p>
<h4 id="Lab-Arbitrary-object-injection-in-PHP"><a href="#Lab-Arbitrary-object-injection-in-PHP" class="headerlink" title="Lab: Arbitrary object injection in PHP"></a>Lab: Arbitrary object injection in PHP</h4><p>这里有个hint我觉得很有帮助，我记得不是23年湾湾那边报了哪个编辑器的洞就是这个：</p>
<p>You can sometimes read source code by appending a tilde (<code>~)</code> to a filename to retrieve an editor-generated backup file.</p>
<p>虽然但是，我怎么该审计哪个文件啊？我一无所知啊😣</p>
<ol>
<li>看来只有change mail 一个功能，使用了POST头，直接访问<code>/my-account/change-email~</code>并不行,emmm,应该是php文件吧？但是直接访问<code>/my-account/change-email</code>时显示<code>&quot;Method Not Allowed&quot;</code></li>
<li>它这个目录结构到底是怎样的呢？</li>
<li>看了眼solution，”From the site map, notice that the website references the file <code>/libs/CustomTemplate.php</code>“ </li>
<li>看了个视频，发现是通过burp suite的Target 栏，Site map 发现的，以前都不知道有这个功能。但是它这个是怎么实现的呢？一个扫描器？</li>
<li>好在代码不长还给提示<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomTemplate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$template_file_path</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$lock_file_path</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$template_file_path</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;template_file_path = <span class="variable">$template_file_path</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;lock_file_path = <span class="variable">$template_file_path</span> . <span class="string">&quot;.lock&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">isTemplateLocked</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;lock_file_path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTemplate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;template_file_path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveTemplate</span>(<span class="params"><span class="variable">$template</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">isTemplateLocked</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;lock_file_path, <span class="string">&quot;&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Could not write to &quot;</span> . <span class="variable language_">$this</span>-&gt;lock_file_path);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;template_file_path, <span class="variable">$template</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Could not write to &quot;</span> . <span class="variable language_">$this</span>-&gt;template_file_path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Carlos thought this would be a good idea</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;lock_file_path)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;lock_file_path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>emmm，想当然。构造lock_file_path属性。有一说一，这个<code>unlink()</code>是干嘛的？php的函数，用来删除文件。符合需求。</li>
<li>也可以通过Hackvertor计算string length<code>&lt;@length&gt;/home/carlos/morale.txt&lt;@/length&gt;</code></li>
<li><code>O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;wiener&quot;;s:12:&quot;access_token&quot;;s:32:&quot;h8ogciry8yqy8fizpuckdy2ckw32hg3l&quot;;s:14:&quot;lock_file_path&quot;;s:23:&quot;/home/carlos/morale.txt&quot;;&#125;</code>不要忘记加最后的<code>;</code>！也不要忘记指出属性名<code>lock_file_path</code></li>
<li>emmm,整错了？应该构建<code>template_file_path</code>但是php是不是会给它加上<code>.lock</code>？需要截断？</li>
<li>hhhh，做昏头了。忘了这节是干嘛的了？要构建<code>CustomTemplate</code>类的object！</li>
<li>总归还是因为不懂php，不懂前端。</li>
<li><code>O:14:&quot;CustomTemplate&quot;:1:&#123;s:14:&quot;lock_file_path&quot;;s:23:&quot;/home/carlos/morale.txt&quot;;&#125;</code>其中<code>O:14:</code>是因为类名CustomTemplate长度为14，后边的参数1是因为只有一项属性</li>
</ol>
<h2 id="Gadget-chains"><a href="#Gadget-chains" class="headerlink" title="Gadget chains"></a>Gadget chains</h2><blockquote>
<p>A “gadget” is a snippet of code that exists in the application that can help an attacker to achieve a particular goal.</p>
</blockquote>
<p> 我原本还以为是什么工具，没想到是application里自带的。</p>
<blockquote>
<p>However, the attacker’s goal might simply be to invoke a method that will pass their input into another gadget.</p>
</blockquote>
<p> 所以是“Gadget chains”是吧？</p>
<blockquote>
<p>By chaining multiple gadgets together in this way, an attacker can potentially pass their input into a dangerous “sink gadget”, where it can cause maximum damage.</p>
</blockquote>
<p> 但是这是怎么做到的呢？这里它还提醒：gadget chain 不是攻击者传过来的payload，它们本身就在website里的。攻击者只是控制传给gadget chain的数据。通常，使用反序列化过程当中的magic method实现，有时被叫做“kick-of gadget”。</p>
<blockquote>
<p>In the wild, many insecure deserialization vulnerabilities will only be exploitable through the use of gadget chains.</p>
</blockquote>
<p>可能只需要一两步chian，但是想实现更严重的攻击就可能得要“a more elaborate sequence of object instantiations and method invocations.”</p>
<p>在利用反序列化漏洞时，构建gadget chains是关键技能之一。</p>
<h3 id="Working-with-pre-built-gadget-chains"><a href="#Working-with-pre-built-gadget-chains" class="headerlink" title="Working with pre-built gadget chains"></a>Working with pre-built gadget chains</h3><p>人工地去辨认gadget chains会非常困难，没源码时更是几乎不可能。</p>
<p>这里提到“pre-built gadget chains”。有很多工具 ，可以提供一系列在其它网站上成功利用，已经被发现的chains。就算得不到源码，也能用这些工具很方便地去辨别，利用反序列化漏洞。</p>
<blockquote>
<p>This approach is made possible due to the widespread use of libraries that contain exploitable gadget chains.</p>
</blockquote>
<p>这让我想起了log4j2和webp的洞（也许后者更为恰当）。</p>
<blockquote>
<p>For example, if a gadget chain in Java’s Apache Commons Collections library can be exploited …… balabala </p>
</blockquote>
<p>emmm，lib安全很重要。🤔这算不算供应链安全？算<a target="_blank" rel="noopener" href="https://www.redhat.com/zh/topics/security/what-is-software-supply-chain-security">什么是软件供应链安全防护？</a></p>
<h4 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h4><p>给出了一个工具。选个目标web用的lib，就可以传入你想执行的代码。”but it is considerably less labor-intensive than constructing your own gadget chains manually.“咱也不知道咋构建。</p>
<blockquote>
<h4 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h4><p> In Java versions 16 and above, you need to set a series of command-line arguments for Java to run ysoserial. 然后给出了一些命令。我不确定这篇文章是否足够新，不放了。</p>
</blockquote>
<blockquote>
<p>you can use the following ones to help you quickly detect insecure deserialization on virtually any server:</p>
</blockquote>
<ul>
<li>The <code>URLDNS</code> chain triggers a DNS lookup for a supplied URL.同时由于它不依赖于目标应用所用的library，并且可以运行在任何Java版本上。用来detection是最普适的。</li>
<li><code>JRMPClient</code> is another universal chain that you can use for initial detection.通过建立TCP连接。</li>
<li><ol>
<li>Note that you need to provide a raw IP address rather than a hostname.</li>
</ol>
</li>
<li><ol start="2">
<li> This chain may be useful in environments where all outbound traffic is firewalled, including DNS lookups.</li>
</ol>
</li>
<li>You can try generating payloads with two different IP addresses: a local one and a firewalled, external one. If the application responds immediately for a payload with a local address, but hangs for a payload with an external address, causing a delay in the response, this indicates that the gadget chain worked because the server tried to connect to the firewalled address. In this case, the subtle time difference in responses can help you to detect whether deserialization occurs on the server, even in blind cases.介玩法也太tm高阶了。</li>
</ul>
<h4 id="Lab-Exploiting-Java-deserialization-with-Apache-Commons"><a href="#Lab-Exploiting-Java-deserialization-with-Apache-Commons" class="headerlink" title="Lab: Exploiting Java deserialization with Apache Commons"></a>Lab: Exploiting Java deserialization with Apache Commons</h4><p> ”loads the Apache Commons Collections library.“”you can still exploit this lab using pre-built gadget chains“<br> 1. 没什么头绪，工具看来需要指定payload，我决定先用<code>urldns</code>试下<br> 2. 这里毫无头绪直接看了solution<br> 3. 题解：<br> 4. 先登陆账户，然后把个request包送去repeater<br> 5. In Java versions 16 and above: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-all.jar \ </span><br><span class="line">--add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.trax=ALL-UNNAMED \ --add-opens=java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime=ALL-UNNAMED \ --add-opens=java.base/java.net=ALL-UNNAMED \ --add-opens=java.base/java.util=ALL-UNNAMED \ CommonsCollections4 <span class="string">&#x27;rm /home/carlos/morale.txt&#x27;</span> | <span class="built_in">base64</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>这里不是很清楚，为什么payload选用<code>CommonsCollections4</code>也没有哪个教程指出<blockquote>
<p><a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7ysoserial%E5%88%86%E6%9E%90.html">https://wooyun.js.org/drops/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%85%B7ysoserial%E5%88%86%E6%9E%90.html</a> 很遗憾，这是篇wooyun上的文章的archive，只能说ysoserial真的是很老了。</p>
</blockquote>
</li>
<li>而且这个gadget chains很老，也没有更新，只能在Java15之下的版本运行。我暂且使用<code>archlinux-java set java-11-openjdk</code>来改变Java版本</li>
<li>而且要将base64编码转为URL编码</li>
<li>😔做得云里雾里</li>
</ol>
<h4 id="PHP-Generic-Gadget-Chains"><a href="#PHP-Generic-Gadget-Chains" class="headerlink" title="PHP Generic Gadget Chains"></a>PHP Generic Gadget Chains</h4><p>提到了proof-of-concept tools ： “PHP Generic Gadget Chains” (PHPGGC).</p>
<p>它又强调了一遍说，漏洞还是因为用户可控数据的反序列化导致的，不要怪罪到gadget chains或者libs头上。就算把所有的gadget chain都堵上，不控制这些不可信数据的反序列化过程，也是无济于事。</p>
<h4 id="Lab-Exploiting-PHP-deserialization-with-a-pre-built-gadget-chain"><a href="#Lab-Exploiting-PHP-deserialization-with-a-pre-built-gadget-chain" class="headerlink" title="Lab: Exploiting PHP deserialization with a pre-built gadget chain"></a>Lab: Exploiting PHP deserialization with a pre-built gadget chain</h4><ol>
<li>phpggc要求php版本大于等于5.6 ，clone下来跑就可以了</li>
<li>那么问题又来了，how to identify the target framework?</li>
<li>ok,看response时发现有一行是注释过的，成功在<code>/cgi-bin/phpinfo.php</code>弹出php信息。接下来就是找了。</li>
<li>翻来覆去不明白，看了眼题解，明白了，超出我的知识储备了已经。序列化的数据中还需要使用SHA-1签名。</li>
</ol>
<p>因此，我的lab和exploiting之旅就到此为止了。</p>
<h2 id="How-to-prevent-insecure-deserialization-vulnerabilities"><a href="#How-to-prevent-insecure-deserialization-vulnerabilities" class="headerlink" title="How to prevent insecure deserialization vulnerabilities"></a>How to prevent insecure deserialization vulnerabilities</h2><ol>
<li>非必要，不对用户输入进行反序列化。</li>
<li>如果确实需要，使用强而有力的措施保证数据没被篡改。比方说，使用数据签名。而且要在反序列化过程之前进行检查</li>
<li></li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/91Quin">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Insecure-deserialization"><span class="toc-number">1.</span> <span class="toc-text">Insecure deserialization</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-serialization"><span class="toc-number">1.1.</span> <span class="toc-text">What is serialization?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Serialization-vs-deserialization"><span class="toc-number">1.1.1.</span> <span class="toc-text">Serialization vs deserialization</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-insecure-deserialization"><span class="toc-number">1.2.</span> <span class="toc-text">What is insecure deserialization?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-do-insecure-deserialization-vulnerabilities-arise"><span class="toc-number">1.3.</span> <span class="toc-text">How do insecure deserialization vulnerabilities arise?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-the-impact-of-insecure-deserialization"><span class="toc-number">1.4.</span> <span class="toc-text">What is the impact of insecure deserialization?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-insecure-deserialization-vulnerabilities"><span class="toc-number">2.</span> <span class="toc-text">Exploiting insecure deserialization vulnerabilities</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-identify-insecure-deserialization"><span class="toc-number">2.1.</span> <span class="toc-text">How to identify insecure deserialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-serialization-format"><span class="toc-number">2.1.1.</span> <span class="toc-text">PHP serialization format</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-serialization-format"><span class="toc-number">2.1.2.</span> <span class="toc-text">Java serialization format</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Manipulating-serialized-objects"><span class="toc-number">2.2.</span> <span class="toc-text">Manipulating serialized objects</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Modifying-object-attributes"><span class="toc-number">2.2.1.</span> <span class="toc-text">Modifying object attributes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB-Modifying-serialized-objects"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">LAB: Modifying serialized objects</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Modifying-data-types"><span class="toc-number">2.2.2.</span> <span class="toc-text">Modifying data types</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB-Modifying-serialized-data-types"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">LAB : Modifying serialized data types</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-application-functionality"><span class="toc-number">2.3.</span> <span class="toc-text">Using application functionality</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LAB-Using-application-functionality-to-exploit-insecure-deserialization"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">LAB: Using application functionality to exploit insecure deserialization</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Magic-methods"><span class="toc-number">2.4.</span> <span class="toc-text">Magic methods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Injecting-arbitrary-objects"><span class="toc-number">2.5.</span> <span class="toc-text">Injecting arbitrary objects</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Lab-Arbitrary-object-injection-in-PHP"><span class="toc-number">2.5.0.1.</span> <span class="toc-text">Lab: Arbitrary object injection in PHP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gadget-chains"><span class="toc-number">2.6.</span> <span class="toc-text">Gadget chains</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Working-with-pre-built-gadget-chains"><span class="toc-number">2.6.1.</span> <span class="toc-text">Working with pre-built gadget chains</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ysoserial"><span class="toc-number">2.6.1.1.</span> <span class="toc-text">ysoserial</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Note"><span class="toc-number">2.6.1.2.</span> <span class="toc-text">Note</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lab-Exploiting-Java-deserialization-with-Apache-Commons"><span class="toc-number">2.6.1.3.</span> <span class="toc-text">Lab: Exploiting Java deserialization with Apache Commons</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PHP-Generic-Gadget-Chains"><span class="toc-number">2.6.1.4.</span> <span class="toc-text">PHP Generic Gadget Chains</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lab-Exploiting-PHP-deserialization-with-a-pre-built-gadget-chain"><span class="toc-number">2.6.1.5.</span> <span class="toc-text">Lab: Exploiting PHP deserialization with a pre-built gadget chain</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-prevent-insecure-deserialization-vulnerabilities"><span class="toc-number">2.7.</span> <span class="toc-text">How to prevent insecure deserialization vulnerabilities</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zhangyijian.cn/Notes/Insecure%20Deserialization/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&text=Portswigger 不安全的反序列化"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&is_video=false&description=Portswigger 不安全的反序列化"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Portswigger 不安全的反序列化&body=Check out this article: https://zhangyijian.cn/Notes/Insecure%20Deserialization/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&title=Portswigger 不安全的反序列化"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&name=Portswigger 不安全的反序列化&description=&lt;p&gt;Portswigger Web Academic 真的顶！&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zhangyijian.cn/Notes/Insecure%20Deserialization/&t=Portswigger 不安全的反序列化"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2025
    Yijian
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/91Quin">项目</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
